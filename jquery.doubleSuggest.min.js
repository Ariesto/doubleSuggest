(function(a){var h={init:function(d){return this.each(function(){function m(b){b&&clearTimeout(b);b=setTimeout(function(){h()},c.keyDelay)}function h(){var b=a.trim(e.val()).replace(/[\\]+|[\/]+/g,"").replace(/\s+/g," ");i=b;if(b.length>=c.minChars){c.beforeRetrieve&&(b=c.beforeRetrieve.call(this,b));e.addClass("loading");c.loadingText&&g.html('<li class="ds-message">'+c.loadingText+"</li>").show();f.show();if(""!==c.remoteSource){n&&n.abort();var l={};l[c.queryParam]=b;n=a.getJSON(c.remoteSource,
a.extend({},l,c.extraParams),function(a){p(a,b,!1)})}c.localSource&&p(c.localSource,b,!0)}else f.hide()}function q(b){if(0<a("li.ds-result-item:visible",f).length){var l=a("li",f),d="down"===b?l.eq(0):l.filter(":last"),g=a("li.active:first",f);0<g.length&&(d="down"===b?g.next():g.prev());l.removeClass("active");d.addClass("active");b=0<d.length?d.data()[c.selectedItemProp]:i;e.val(b)}}function p(b,d,h){var b=c.retrieveComplete.call(this,b,d),m=c.seekVal.split(","),i=0,j=0;h&&(g.html(""),f.hide());
for(var n in b)if(b.hasOwnProperty(n)){str="";for(var o=0;o<m.length;o++)str+=b[j][a.trim(m[o])];c.matchCase||(str=str.toLowerCase(),d=d.toLowerCase());if(-1!==str.search(d)){b[j]._dataSource=h?"local":"remote";b[j]._position=i;var o=a('<li class="ds-result-item" id="ds-result-item-'+j+'"></li>').data(b[j]),k=a.extend({},b[j]),p=RegExp("(?![^&;]+;)(?!<[^<>]*)("+d+")(?![^<>]*>)(?![^&;]+;)",""+(!c.matchCase?"gi":"g")+"");c.resultsHighlight&&(k[c.selectedItemProp]=k[c.selectedItemProp].replace(p,"<em>$1</em>"));
g.append(c.formatList.call(this,k,o));i++;if(c.queryLimit&&c.queryLimit==i)break}j++}e.removeClass("loading");0>=i&&c.emptyText&&g.html('<li class="ds-message">'+c.emptyText+"</li>");f.show();c.resultsComplete.call(this)}var c=a.extend(a.fn.doubleSuggest.defaults,d),e=a(this),r=e.attr("id");e.attr("autocomplete","off").addClass("ds-input").val(c.startText);var k=a('<div class="ds-container" id="ds-container-'+r+'"></div>');e.wrap(k);var f=a('<div class="as-results" id="as-results-'+r+'"></div>').hide();
e.after(f);var g=a('<ul class="ds-list"></ul>').css("width",e.outerWidth()).appendTo(f),i="",n=null;e.on({"focus.doubleSuggest":function(){e.val()===c.startText&&e.val("");a("li.as-selection-item",k).removeClass("blur");""!==a.trim(e.val())&&f.show()},"keydown.doubleSuggest":function(b){lastKey=b.keyCode;switch(lastKey){case 38:case 40:b.preventDefault();38===lastKey?q("up"):q("down");break;case 8:1===e.val().length&&f.hide();m(lastKey,null);break;case 9:case 188:case 13:var d=a.trim(e.val()).replace(/(,)/g,
"");if(""!==d&&d.length>=c.minChars&&(9===lastKey||13===lastKey)&&0<a("li.ds-result-item:visible",f).length&&0<a("li.active:first",g).length)a("li.active:first",g).trigger("select"),b.preventDefault();break;default:46==lastKey||9<lastKey&&32>lastKey?f.hide():m(null)}},"blur.doubleSuggest":function(){""===e.val()&&e.val(c.startText);f.is(":hover")||(a("li.as-selection-item",k).addClass("blur").removeClass("selected"),f.hide())},"updateOptions.doubleSuggest":function(b,e){c=a.extend(a.fn.doubleSuggest.defaults,
d,e)},"destroy.doubleSuggest":function(){f.remove();e.val("").removeClass("ds-input").unbind(".doubleSuggest").unwrap()}});f.on({click:function(){a(this).trigger("select")},mouseover:function(){a("li",g).removeClass("active");a(this).addClass("active")},select:function(){var b=a(this).data();i=b[c.selectedItemProp];e.val(i).focus();c.onSelect.call(this,b);f.hide()}},".ds-result-item")})},update:function(d){return this.each(function(){a(this).trigger("updateOptions",d)})},destroy:function(){return this.each(function(){a(this).trigger("destroy")})}};
a.fn.doubleSuggest=function(d){if(h[d])return h[d].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof d||!d)return h.init.apply(this,arguments);a.error("Invalid arguments "+d+" on jQuery.doubleSuggest")};a.fn.doubleSuggest.defaults={localSource:{},remoteSource:!1,startText:"Search",emptyText:!1,loadingText:"Loading...",newItem:!1,selectedItemProp:"name",seekVal:"name",queryParam:"q",queryLimit:!1,extraParams:{},matchCase:!1,minChars:1,keyDelay:500,resultsHighlight:!0,onSelect:function(){},
formatList:function(a,h){return h.html(a[opts.selectedItemProp])},beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultsComplete:function(){}}})(jQuery);